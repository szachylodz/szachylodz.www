(function(e){"use strict";function K(e,t,n){this.pgn=e,this.index=t,this[h]=n;for(var r=3;r<arguments[p];++r){var i=new RegExp("%"+(r-2)+"\\$s");this[h]=this[h][d](i,arguments[r])}}function Q(t,n){this[v]=t,this._next=m,this[g]=new e.Position(t[y]());if(n===b){this[w]=b;if(!this[g].playNullMove())throw new e[S][E](this[g],b,J[r])}else{var i=this[g].notation(n);this[w]=this[g].notation(i),this[g].play(i)}this[x]=t[y]().turn(),t instanceof G?this[T]=t[v][T]:this[T]=this[x]==="w"?t[T]+1:t[T],this[N]=t[N],this[C]=[],this[k]=[],this[L]={},this[A]=m,this[O]=M,t instanceof G?t[_]=this:t._next=this}function G(e,t){this[v]=e,this[_]=m,this[N]=t,this[k]=[],this[L]={},this[A]=m,this[O]=M,e instanceof Y?e[R]=this:e[C][j](this)}function Y(){this[z]={},this[W]=new e.Position,this[T]=1,this[X]="*",new G(this,!0)}function ut(e){var t={},n=e[d](/\[%([a-zA-Z]+) ([^\[\]]+)\]/g,function(e,n,r){return t[n]=r," "});return n=n[d](/^\s+|\s+$/g,"")[d](/\s+/g," "),n===""&&(n=m),{comment:n,tags:t}}function at(r){function b(){var e=0;while(l<r[p]){var t=r.substr(l);if(/^([ \f\t\v])+/[$](t))l+=RegExp.$1[p];else{if(!/^(\r?\n|\r)/[$](t))break;l+=RegExp.$1[p],++e}}c=e>=2}function w(){b();if(l>=r[p])return M;var e=r.substr(l),n=0;if(/^(\[\s*(\w+)\s+\"([^\"]*)\"\s*\])/[$](e))n=RegExp.$1[p],v=et,g={key:RegExp.$2,value:RegExp.$3};else if(/^((?:[1-9][0-9]*\s*\.(?:\.\.)?\s*)?((?:O-O-O|O-O|[KQRBN][a-h]?[1-8]?x?[a-h][1-8]|(?:[a-h]x?)?[a-h][1-8](?:=?[KQRBNP])?)[\+#]?|--))/[$](e))n=RegExp.$1[p],v=tt,g=RegExp.$2;else if(/^(([!\?][!\?]?|\+\/?[\-=]|[\-=]\/?\+|=|inf|~)|\$([1-9][0-9]*))/[$](e))n=RegExp.$1[p],v=nt,g=RegExp.$3[p]===0?Z[RegExp.$2]:parseInt(RegExp.$3,10);else if(/^(\{((?:\\\\|\\\{|\\\}|[^\{\}])*)\})/[$](e))n=RegExp.$1[p],v=rt,g=ut(RegExp.$2[d](/\\(\\|\{|\})/g,"$1"));else if(/^(\()/[$](e))n=RegExp.$1[p],v=it,g=m;else if(/^(\))/[$](e))n=RegExp.$1[p],v=st,g=m;else{if(!/^(1\-0|0\-1|1\/2\-1\/2|\*)/[$](e))throw new K(r,l,J[t]);n=RegExp.$1[p],v=ot,g=RegExp.$1}return y=l,l+=n,!0}var l=0,c=M,v=0,g=m,y=0,x=[],C=m,_=m,D=[];while(w()){C===m&&(C=new Y),v!==et&&_===m&&(_=C[V]());switch(v){case et:if(_!==m)throw new K(r,y,J[s]);C[z][g.key]=g.value;if(g.key==="FEN")try{var P=C[W].fen(g.value);C[T]=P[H]}catch(B){throw B instanceof e[S].InvalidFEN?new K(r,y,J[i],B[h]):B}break;case tt:try{_=new Q(_,g)}catch(B){throw B instanceof e[S][E]?new K(r,y,J[n],B[h]):B}break;case nt:_[k][j](g);break;case rt:_[L]=g.tags,_[A]=g[I],_[O]=_[N]&&c;break;case it:if(!(_ instanceof Q))throw new K(r,y,J[o]);D[j](_),_=new G(_,_[N]&&c);break;case st:if(D[p]===0)throw new K(r,y,J[u]);_=D.pop();break;case ot:if(D[p]>0)throw new K(r,y,J[a]);C[X]=g,x[j](C),C=m,_=m}}if(C!==m)throw new K(r,r[p],J[f]);return x}function ft(e){var t=at(e);switch(t[p]){case 0:throw new K(e,-1,J[l]);case 1:return t[0];default:throw new K(e,-1,J[c])}}var t="INVALID_PGN_TOKEN",n="INVALID_MOVE_IN_PGN_TEXT",r="INVALID_NULL_MOVE_IN_PGN_TEXT",i="INVALID_FEN_IN_PGN_TEXT",s="UNEXPECTED_PGN_HEADER",o="UNEXPECTED_BEGIN_OF_VARIATION",u="UNEXPECTED_END_OF_VARIATION",a="UNEXPECTED_END_OF_GAME",f="UNEXPECTED_END_OF_TEXT",l="PGN_TEXT_IS_EMPTY",c="PGN_TEXT_CONTAINS_SEVERAL_GAMES",h="message",p="length",d="replace",v="_parent",m=null,g="_position",y="position",b="--",w="_notation",E="InvalidNotation",S="exceptions",x="_movingColor",T="_fullMoveNumber",N="_withinLongVariation",C="_variations",k="_nags",L="_tags",A="_comment",O="_isLongComment",M=!1,_="_first",D="prototype",P="positionBefore",H="fullMoveNumber",B="hasOwnProperty",j="push",F="string",I="comment",q="isLongComment",R="_mainVariation",U="initialPosition",z="_headers",W="_initialPosition",X="_result",V="mainVariation",$="test",J=e.i18n;J[t]="Unrecognized character or group of characters.",J[n]="Invalid move. %1$s",J[r]="Invalid null-move.",J[i]="Invalid FEN string in the initial position header. %1$s",J[s]="Unexpected PGN item header.",J[o]="Unexpected begin of variation.",J[u]="Unexpected end of variation.",J[a]="Unexpected end of game: there are pending variations.",J[f]="Unexpected end of text: there is a pending item.",J[l]="No game found in the text.",J[c]="The PGN data contains 2 or more games.",Q[D].move=function(){return this[w]},Q[D][P]=function(){return this[v][y]()},Q[D][y]=function(){return this[g]},Q[D][H]=function(){return this[T]},Q[D].moveColor=function(){return this[x]},Q[D].next=function(){return this._next},Q[D].variations=function(){return this[C]},Q[D].nags=function(){return this[k]},Q[D].tags=function(){var e=[];for(var t in this[L])this[L][B](t)&&e[j](t);return e},Q[D].tag=function(e){var t=this[L][e];return typeof t===F?t:m},Q[D][I]=function(){return this[A]},Q[D][q]=function(){return this[O]},G[D].isLongVariation=function(){return this[N]},G[D][y]=function(){return this[v]instanceof Q?this[v][P]():this[v][U]()},G[D].first=function(){return this[_]},G[D].nags=Q[D].nags,G[D].tags=Q[D].tags,G[D].tag=Q[D].tag,G[D][I]=Q[D][I],G[D][q]=Q[D][q],Y[D].headers=function(){var e=[];for(var t in this[z])this[z][B](t)&&e[j](t);return e},Y[D].header=function(e){var t=this[z][e];return typeof t===F?t:m},Y[D][U]=function(){return this[W]},Y[D][V]=function(){return this[R]},Y[D].result=function(){return this[X]};var Z={"!!":3,"!":1,"!?":5,"?!":6,"?":2,"??":4,"+-":18,"+/-":16,"+/=":14,"+=":14,"=":10,"~":13,inf:13,"=/+":15,"=+":15,"-/+":17,"-+":19},et=1,tt=2,nt=3,rt=4,it=5,st=6,ot=7;e[S].InvalidPGN=K,e.pgn={Node:Q,Variation:G,Item:Y,parse:at,parseOne:ft}})(RPBChess);