(function(e,t,n){"use strict";function Tt(e){return e===o||e==="?"?o:e}function Nt(e){if(e===o||e==="????.??.??")return o;if(e.match(/([0-9]{4})\.([0-9]{2})\.([0-9]{2})/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-"+RegExp.$3);return t.isValid()?Ot(t.format("LL")):e}if(e.match(/([0-9]{4})\.([0-9]{2})\.\?\?/)){var t=n(RegExp.$1+"-"+RegExp.$2+"-01");return t.isValid()?Ot(t.format("MMMM YYYY")):e}return e.match(/([0-9]{4})\.\?\?\.\?\?/)?RegExp.$1:e}function Ct(e){switch(e){case"*":return o;case"1/2-1/2":return"&#189;&#8211;&#189;";case"1-0":return"1&#8211;0";case"0-1":return"0&#8211;1";default:return e}}function kt(e){return e===o||e==="-"?o:e}function At(e){return e===o?o:e in Lt?Lt[e]:"$"+e}function Ot(e){return e[N]===0?"":e.charAt(0).toUpperCase()+e.slice(1)}function Mt(e,t,n,r){var i=t-n,s="...";i<=0&&(i=0,s="");var o=t+1+r,u="...";o>=e[N]&&(o=e[N],u="");var a=s+e.substr(i,o-i)+u;return a=a[z](/\n|\t/g," "),a+"\n"+(new Array(1+s[N]+t-i)).join(" ")+"^"}function _t(e){var n=t.Color(e);return n.lightness()>.5?"black":"white"}function Dt(e){switch(e){case D:case et:case G:case"above":case"below":return e;default:return J}}function Pt(e){switch(e){case"merida":case"pirat":break;default:e="alpha"}var t='<span class="uichess-chessgame-'+e+'Font">',n=d,r={K:t+"K"+n,Q:t+"Q"+n,R:t+"R"+n,B:t+"B"+n,N:t+"N"+n,P:t+"P"+n};return{font:e,pieceSymbolTable:r}}function Ht(e){var t={};return typeof e[K]!==f&&(t[K]=e[K]),typeof e[Q]!==f&&(t[Q]=e[Q]),typeof e[B]!==f&&(t[B]=e[B]),typeof e[ot]!==f&&(t[ot]=e[ot]),typeof e[at]!==f&&(t[at]=e[at]),typeof e[j]!==f&&(t[j]=e[j]),typeof e[q]!==f&&(t[q]=e[q]),t}function Bt(e){if(e===undefined||e===o)e=t(v);e.attr("style",o).attr("id",o)[$](E)}function jt(){return'<div class="uichess-chessgame-navigationBoard"></div><div class="uichess-chessgame-navigationButtons"><button class="uichess-chessgame-navigationButtonFrst">&lt;&lt;</button><button class="uichess-chessgame-navigationButtonPrev">&lt;</button><button class="uichess-chessgame-navigationButtonNext">&gt;</button><button class="uichess-chessgame-navigationButtonLast">&gt;&gt;</button>'+h}function Ft(){function n(e){var n=t(v).closest(".uichess-chessgame");n[S](e);var i=t(r,n),s=X;i.hasClass("uichess-chessgame-initialMove")&&(i=n,s=x);var o=i.offset();o.top<t(window).scrollTop()?t(ht).animate({scrollTop:o.top},200):s&&o.top+i.height()>t(window).scrollTop()+window.innerHeight&&t(ht).animate({scrollTop:o.top+i.height()-window.innerHeight},200)}if(t(s)[N]!==0)return;t('<div id="uichess-chessgame-navigationFrame">'+jt()+h)[gt](t("body")),t(s)[pt]({create:function(e){t(e.target).parent().css(w,ct)},resizeStart:function(e){t(e.target).parent().css(w,ct)},resizeStop:function(e){t(e.target).parent().css(w,ct)},autoOpen:x,dialogClass:t[S].navigationFrameClass,width:"auto",close:function(){Bt()}});var e=t(y);e[b](Ht(t[S].navigationFrameOptions)),e[b]("sizeControlledByContainer",t(s),"dialogresize"),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonFrst")[Y](function(e){e[m](),n(mt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonPrev")[Y](function(e){e[m](),n(st)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonNext")[Y](function(e){e[m](),n(xt)}),t("#uichess-chessgame-navigationFrame .uichess-chessgame-navigationButtonLast")[Y](function(e){e[m](),n(St)})}var r=".uichess-chessgame-selectedMove",i="navigationBoard",s="#uichess-chessgame-navigationFrame",o=null,u="options",a="element",f="undefined",l="navigationBoardOptions",c="_updateNavigationBoard",h="</div>",p="_pieceSymbolTable",d="</span>",v="#uichess-chessgame-navigationFrameTarget",m="preventDefault",g="_game",y="#uichess-chessgame-navigationFrame .uichess-chessgame-navigationBoard",b="chessboard",w="position",E="uichess-chessgame-selectedMove",S="chessgame",x=!1,T=".uichess-chessgame-move",N="length",C="_buildPositionInformation",k="nextMove",L="prevMove",A="diagramOptions",O="option",M=".uichess-chessgame-navigationBoard",_="data",D="frame",P='<div class="uichess-chessgame-',H=".uichess-chessgame-initialMove",B="showCoordinates",j="animationSpeed",F="pieceSymbols",I="isLongVariation",q="showMoveArrow",R="_initializePieceSymbols",U="uichess-chessgame",z="replace",W="header",X=!0,V="isLongComment",$="removeClass",J="none",K="flip",Q="squareSize",G="floatRight",Y="click",Z="comment",et="floatLeft",tt="_destroyContent",nt="_playerNameHeader",rt="positionBefore",it="addClass",st="goPreviousMove",ot="colorset",ut="_initializePGN",at="pieceset",ft="squareMarkers",lt="pieceSymbolTable",ct="fixed",ht="html, body",pt="dialog",dt="_buildVariation",vt="arrowMarkers",mt="goFirstMove",gt="appendTo",yt="PIECE_SYMBOLS",bt="mainVariation",wt="_buildComment",Et="children",St="goLastMove",xt="goNextMove";t[S]={navigationFrameOptions:{},navigationFrameClass:"",chessFont:"alpha",i18n:{ANNOTATED_BY:"Annotated by %1$s",INITIAL_POSITION:"Initial position",PIECE_SYMBOLS:{K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"}}};var Lt={3:"!!",1:"!",5:"!?",6:"?!",2:"?",4:"??",18:"+−",16:"±",14:"⩲",10:"=",11:"=",13:"∞",15:"⩱",17:"∓",19:"−+"};t.widget("uichess.chessgame",{options:{pgn:"*",navigationBoard:J,navigationBoardOptions:{},diagramOptions:{},pieceSymbols:"native"},_game:o,_pieceSymbolTable:o,_create:function(){this[a][it](U),this[u].pgn=this[ut](this[u].pgn),this[u][F]=this[R](this[u][F]),this[u][i]=Dt(this[u][i]),this[u][l]=Ht(this[u][l]),this[u][A]=Ht(this[u][A]),this._refresh()},_destroy:function(){this[tt](),this[a][$](U)},_setOption:function(e,t){switch(e){case"pgn":t=this[ut](t);break;case F:t=this[R](t);break;case i:t=Dt(t);break;case l:t=Ht(t);break;case A:t=Ht(t)}this[u][e]=t,this._refresh()},goFirstMove:function(){var e=t(r,this[a]);if(e[N]===0)return;while(e[_](L)!==undefined)e=e[_](L);this[c](e,x)},goPreviousMove:function(){this[c](t(r,this[a])[_](L),x)},goNextMove:function(){this[c](t(r,this[a])[_](k),X)},goLastMove:function(){var e=t(r,this[a]);if(e[N]===0)return;while(e[_](k)!==undefined)e=e[_](k);this[c](e,x)},_initializePGN:function(t){typeof t!="string"&&(t="*"),t=t[z](/^\s+|\s+$/g,"");try{this[g]=e.pgn.parseOne(t)}catch(n){if(!(n instanceof e.exceptions.InvalidPGN))throw this[g]=o,n;this[g]=n}return t},_initializePieceSymbols:function(e){var n=["K","Q","R","B","N","P"];if(/^\([a-zA-Z]{6}\)$/.test(e)){e=e.toUpperCase(),this[p]={};for(var r=0;r<6;++r)this[p][n[r]]=e.substr(r+1,1)}else if(/^:\w+$/.test(e)){var i=Pt(e.substr(1));e=":"+i.font,this[p]=i[lt]}else switch(e){case"figurines":this[p]=Pt(t[S].chessFont)[lt];break;case"localized":this[p]={};for(var r=0;r<6;++r){var s=n[r];this[p][s]=s in t[S].i18n[yt]?t[S].i18n[yt][s]:s}break;default:this[p]={K:"K",Q:"Q",R:"R",B:"B",N:"N",P:"P"},e="native"}return e},_destroyContent:function(){var e=t(v,this[a]);e[N]!==0&&t(s)[pt]("close"),this[a].empty()},_refresh:function(){this[tt]();if(this[g]===o)return;if(this[g]instanceof e.exceptions.InvalidPGN){t(this._buildErrorMessage())[gt](this[a]);return}var n="";n+=this[nt]("White"),n+=this[nt]("Black"),n+=this._eventHeader(),n+=this._datePlaceHeader(),n+=this._annotatorHeader(),n!==""&&(n='<div class="uichess-chessgame-headers">'+n+h);var r=this._buildInitialMove(),s=this._buildBody(),f="",l="";switch(this[u][i]){case et:case G:l=P+this[u][i][z]("float","clear")+'"></div>',f='<div class="uichess-chessgame-navigationBox uichess-chessgame-'+this[u][i]+'">'+jt()+h;break;case"above":f='<div class="uichess-chessgame-navigationBox uichess-chessgame-above">'+jt()+h;break;case"below":l='<div class="uichess-chessgame-navigationBox uichess-chessgame-below">'+jt()+h}t(f+r+n+s+l)[gt](this[a]),this._makeDiagrams(),this[u][i]!==J&&(this._makeMovesClickable(),this._makeMovesRelated(),this[u][i]!==D&&this._makeNavigationBoxWidgets())},_makeDiagrams:function(){var e=this;t(".uichess-chessgame-comment .uichess-chessgame-diagramAnchor",this[a]).each(function(n,r){var i=t(r),s=i.closest(".uichess-chessgame-comment"),o=s[_](w),a=s[_]("csl"),l=s[_]("cal"),c={position:o};typeof a!==f&&(c[ft]=a),typeof l!==f&&(c[vt]=l),t.extend(c,e[u][A]);try{t.extend(c,Ht(t.parseJSON(i.text())))}catch(h){}i.empty()[$]("uichess-chessgame-diagramAnchor")[it]("uichess-chessgame-diagram")[b](c)})},_makeMovesClickable:function(){var e=this;t(T,this[a])[Y](function(){e[c](t(this),x)})},_makeMovesRelated:function(){t(".uichess-chessgame-variation").each(function(e,n){var r=t(n),i=r.is("div")?r[Et](".uichess-chessgame-moveGroup")[Et](T):r[Et](T),s=o;i.each(function(e,n){var r=t(n);s!==o&&(r[_](L,s),s[_](k,r)),s=r})});var e=t(H,this[a]),n=t(".uichess-chessgame-variation .uichess-chessgame-move",this[a]);if(n[N]!==0){var r=n.first();r[_](L,e),e[_](k,r)}},_makeNavigationBoxWidgets:function(){t(M,this[a])[b](this[u][l]);var e=this;t(".uichess-chessgame-navigationButtonFrst",this[a])[Y](function(t){t[m](),e[mt]()}),t(".uichess-chessgame-navigationButtonPrev",this[a])[Y](function(t){t[m](),e[st]()}),t(".uichess-chessgame-navigationButtonNext",this[a])[Y](function(t){t[m](),e[xt]()}),t(".uichess-chessgame-navigationButtonLast",this[a])[Y](function(t){t[m](),e[St]()}),this[c](t(H,this[a]),x)},_buildErrorMessage:function(){var e='<div class="uichess-chessgame-error"><div class="uichess-chessgame-errorTitle">Error while analysing a PGN string.</div>';return this[g].message!==o&&(e+='<div class="uichess-chessgame-errorMessage">'+this[g].message+h),this[g].index!==o&&this[g].index>=0&&(e+='<div class="uichess-chessgame-errorAt">',this[g].index>=this[g].pgn[N]?e+="Occurred at the end of the string.":e+="Occurred at position "+this[g].index+":"+'<div class="uichess-chessgame-errorAtCode">'+Mt(this[g].pgn,this[g].index,10,40)+h,e+=h),e+=h,e},_playerNameHeader:function(e){var t=Tt(this[g][W](e));if(t===o)return"";var n=P+e.toLowerCase()+'Player">'+'<span class="uichess-chessgame-colorTag"></span> '+'<span class="uichess-chessgame-playerName">'+t+d,r=kt(this[g][W](e+"Title")),i=Tt(this[g][W](e+"Elo"));if(r!==o||i!==o)n+='<span class="uichess-chessgame-titleRatingGroup">',r!==o&&(n+='<span class="uichess-chessgame-playerTitle">'+r+d),i!==o&&(n+='<span class="uichess-chessgame-playerRating">'+i+d),n+=d;return n+=h,n},_eventHeader:function(){var e=Tt(this[g][W]("Event"));if(e===o)return"";var t=Tt(this[g][W]("Round")),n='<div class="uichess-chessgame-event">'+e;return t!==o&&(n+='<span class="uichess-chessgame-round">'+t+d),n+=h,n},_datePlaceHeader:function(){var e=Nt(this[g][W]("Date")),t=Tt(this[g][W]("Site"));if(e===o&&t===o)return"";var n='<div class="uichess-chessgame-datePlaceGroup">';return e!==o&&(n+='<span class="uichess-chessgame-date">'+e+d),t!==o&&(n+='<span class="uichess-chessgame-site">'+t+d),n+=h,n},_annotatorHeader:function(){var e=Tt(this[g][W]("Annotator"));if(e===o)return"";var n='<div class="uichess-chessgame-annotator">'+t[S].i18n.ANNOTATED_BY[z](/%1\$s/g,'<span class="uichess-chessgame-annotatorName">'+e+d)+h;return n},_buildBody:function(){var e=this[dt](this[g][bt](),X,Ct(this[g].result()));if(e.content==="")return"";var t="uichess-chessgame-body";return e.divCount>1&&(t+=" uichess-chessgame-moreSpace"),this[u][i]!==J&&(t+=" uichess-chessgame-clickableMoves"),'<div class="'+t+'">'+e.content+h},_buildVariation:function(e,t,n){function f(){s&&!u&&(i+='<div class="uichess-chessgame-moveGroup">',u=X,++a)}function l(){u&&(i+=h,u=x)}if(e[Z]()===o&&e.first()===o&&n===o)return t?{content:"",divCount:0}:"";var r=e[I]()?"div":"span",i="<"+r+' class="uichess-chessgame-variation'+(t?"":" uichess-chessgame-subVariation")+'">',s=e[I](),u=x,a=0;e[Z]()!==o&&(e[V]()?++a:f(),i+=this[wt](e));var c=X,p=e.first();while(p!==o){f(),i+=this._buildMove(p,c),p[Z]()!==o&&(p[V]()&&(l(),++a),i+=this[wt](p));var v=0,m=p.variations();for(var g=0;g<m[N];++g){var y=this[dt](m[g],x,o);y!==""&&(m[g][I]()?(l(),++a):f(),i+=y,++v)}c=p[Z]()!==o||v>0,p=p.next()}return t&&n!==o&&(f(),i+='<span class="uichess-chessgame-result">'+n+d),l(),i+="</"+r+">",t?{content:i,divCount:a}:i},_buildPositionInformation:function(e,t){var n='data-position="'+e[w]().fen()+'"';t&&(n+=' data-position-before="'+e[rt]().fen()+'" data-move-notation="'+e.move()+'"');var r=e.tag("csl");r!==o&&(n+=' data-csl="'+r+'"');var i=e.tag("cal");return i!==o&&(n+=' data-cal="'+i+'"'),n},_buildComment:function(e){var t=e[V]()?"div":"span";return"<"+t+' class="uichess-chessgame-comment" '+this[C](e,x)+">"+e[Z]()+"</"+t+">"},_buildMove:function(e,t){var n='<span class="uichess-chessgame-move" '+this[C](e,X)+">",r=t||e.moveColor()==="w",i="uichess-chessgame-moveNumber"+(r?"":" uichess-chessgame-hidden"),s=e.fullMoveNumber()+(e.moveColor()==="w"?".":"…");n+='<span class="'+i+'">'+s+d;var o=this[p];n+=e.move()[z](/[KQRBNP]/g,function(e){return o[e]});var u=e.nags();for(var a=0;a<u[N];++a)n+=" "+At(u[a]);return n+=d,n},_buildInitialMove:function(){return'<div class="uichess-chessgame-move uichess-chessgame-initialMove" '+this[C](this[g][bt](),x)+">"+t[S].i18n.INITIAL_POSITION+h},_updateNavigationBoard:function(e,n){if(e===undefined||e===o||e.hasClass(E))return;this[u][i]===D&&Ft(),this._updateNavigationBoardWidget(e,n),this._updateSelectedMove(e);if(this[u][i]===D){var r=t(s);r[pt]("isOpen")||(r[pt](O,w,{my:"center",at:"center",of:window}),r[pt]("open")),t(".ui-dialog-title",r.closest(".ui-dialog")).empty().append(e.html())}},_updateNavigationBoardWidget:function(e,n){var r=this[u][i]===D?t(y):t(M,this[a]);n?(r[b](O,w,e[_](rt)),r[b]("play",e[_]("moveNotation"))):r[b](O,w,e[_](w));var s=e[_]("csl"),o=e[_]("cal");r[b](O,ft,typeof s===f?"":s),r[b](O,vt,typeof o===f?"":o),this[u][l][K]!==r[b](O,K)&&r[b](O,K,this[u][l][K])},_updateSelectedMove:function(e){var n=this[u][i]===D;Bt(n?o:t(r,this[a])),e[it](E),n&&e.attr("id","uichess-chessgame-navigationFrameTarget");var s=e.css("color");e.css("background-color",s),e.css("color",_t(s))}})})(RPBChess,jQuery,moment);