(function(e,t){"use strict";function St(e,t){var n={},r=e.split(",");for(var i=0;i<r.length;++i)t[G](r[i])&&(n[RegExp.$2]=RegExp.$1);return n}function xt(e){var t=[];for(var n in e)e[A](n)&&t.push(e[n]+n);return t.join(",")}function Tt(e,t){return typeof e=="boolean"?e:typeof e=="number"?Boolean(e):typeof e=="string"?(e=e.toLowerCase(),e==="true"||e==="1"||e==="on"?it:e==="false"||e==="0"||e==="off"?M:t):t}function Nt(e){return Math.min(Math.max(e,vt),mt)}function Ct(e){if(typeof e=="string"){e=e.toLowerCase();if(/^[a-z0-9]+(?:-[a-z0-9]+)*$/[G](e))return e}return""}function kt(e){return e===ot||e===at||/^addPieces-[wb][kqrbnp]$/[G](e)||/^add(?:Square|Arrow)Markers-[GRY]$/[G](e)?e:"none"}function Lt(e){return Math.max(0,e)}function At(t,n){n=n.replace(/^\s+|\s+$/g,"");try{t[s]=new e.Position(n),n=t[s].fen()}catch(r){if(!(r instanceof e.exceptions.InvalidFEN))throw t[s]=T,r;t[s]=r}return n}function Ot(e,t){return e[i]=St(t,yt),xt(e[i])}function Mt(e,t){return e[r]=St(t,bt),xt(e[r])}function _t(e){e[u][Y]()}function Dt(e){var t='<div class="uichess-chessboard-error"><div class="uichess-chessboard-errorTitle">Error while analysing a FEN string.</div>';return e[s].message!==T&&(t+='<div class="uichess-chessboard-errorMessage">'+e[s].message+N),t+=N,t}function Pt(t){var o=t[n][_]?W:I,u=t[n][_]?R:U,a="uichess-chessboard-table uichess-chessboard-size"+t[n][l];t[n][x]||(a+=" uichess-chessboard-hideCoordinates"),t[n][J]!==""&&(a+=" uichess-chessboard-colorset-"+t[n][J]),t[n][$]!==""&&(a+=" uichess-chessboard-pieceset-"+t[n][$]);var f=X+a+'">';for(var c=0;c<8;++c){f+='<div class="uichess-chessboard-row"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate">'+o[c]+N;for(var h=0;h<8;++h){var d=u[h]+o[c],v=e.squareColor(d)==="w"?"light":"dark",g="uichess-chessboard-sized uichess-chessboard-cell uichess-chessboard-square uichess-chessboard-"+v+"Square";d in t[i]&&(g+=" uichess-chessboard-squareMarker uichess-chessboard-markerColor-"+t[i][d]),f+=X+g+'">';var y=t[s][m](d);y==="-"?f+=gt:f+=p+y.piece+q+y.color+'">'+gt+N,f+=N}f+='<div class="uichess-chessboard-cell">';if(o[c]==="8"||o[c]==="1"){var w=o[c]==="8"?"b":"w",g="uichess-chessboard-sized uichess-chessboard-turnFlag uichess-chessboard-color-"+w;w!==t[s].turn()&&(g+=" uichess-chessboard-inactiveFlag"),f+=X+g+'"></div>'}f+="</div></div>"}f+='<div class="uichess-chessboard-row uichess-chessboard-columnCoordinateRow"><div class="uichess-chessboard-cell uichess-chessboard-rowCoordinate"></div>';for(var h=0;h<8;++h)f+='<div class="uichess-chessboard-cell uichess-chessboard-columnCoordinate">'+u[h]+N;f+='<div class="uichess-chessboard-cell"></div></div>',f+='<svg class="uichess-chessboard-annotations" viewBox="0 0 8 8"><defs><marker id="uichess-chessboard-arrowMarkerEnd-G" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-R" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-Y" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker><marker id="uichess-chessboard-arrowMarkerEnd-B" markerWidth="4" markerHeight="4" refX="2.5" refY="2" orient="auto"><path d="M 4,2 L 0,4 L 1,2 L 0,0 Z" /></marker></defs>';for(var E in t[r])if(t[r][A](E)&&/^([a-h][1-8])([a-h][1-8])$/[G](E)){var S=RegExp.$1,T=RegExp.$2;if(S!==T){var k=Vt(t,S,T),g="uichess-chessboard-arrowMarker uichess-chessboard-arrowMarker-"+S+T+b+t[r][E],L=C+t[r][E]+")";f+='<line class="'+g+'" x1="'+k.x1+'" y1="'+k.y1+'" x2="'+k.x2+'" y2="'+k.y2+'" marker-end="'+L+'" />'}}return f+="</svg>",f+=N,f}function Ht(r){_t(r);if(r[s]===T)return;if(r[s]instanceof e.exceptions.InvalidFEN)t(Dt(r)).appendTo(r[u]);else{t(Pt(r)).appendTo(r[u]);if(r[n][c]===ot||r[n][c]===at)$t(r),Jt(r,r[n][c]===ot);else if(/^addPieces-([wb])([kqrbnp])$/[G](r[n][c])){var i=RegExp.$1,o=RegExp.$2;$t(r),Kt(r,{color:i,piece:o})}else if(/^addSquareMarkers-([GRY])$/[G](r[n][c])){var a=RegExp.$1;$t(r),Qt(r,a)}else if(/^addArrowMarkers-([GRY])$/[G](r[n][c])){var a=RegExp.$1;$t(r),Gt(r,a)}}}function Bt(e){t(B,e[u])[nt](O)}function jt(e,n,r){t(a,e[u])[v](K+n)[k](K+r)}function Ft(e){t(a,e[u])[nt]("uichess-chessboard-hideCoordinates")}function It(e,t,n){typeof t===y?e[k](h)[k](f+n):typeof n===y?e[v](h)[v](f+t):e[v](f+t)[k](f+n)}function qt(e){var n=t(".uichess-chessboard-squareMarker",e[u]);n[v]("uichess-chessboard-markerColor-G"),n[v]("uichess-chessboard-markerColor-R"),n[v]("uichess-chessboard-markerColor-Y"),n[v](h);for(var r in e[i])if(e[i][A](r)){var s=e[i][r];Wt(e,r)[k](h)[k](f+s)}}function Rt(e,n,r,i){var s=P+n;if(typeof r===y){var o=n.substr(0,2),a=n.substr(2,2);if(o!==a){var f=Vt(e,o,a);zt(e,s,i,f.x1,f.y1,f.x2,f.y2)}}else if(typeof i===y)t(s,e[u])[lt]();else{var l=j+s+b+i;t(s,e[u]).attr("class",l)}}function Ut(e){t(".uichess-chessboard-arrowMarker",e[u])[lt]();for(var n in e[r])if(e[r][A](n)){var i=n.substr(0,2),s=n.substr(2,2);if(i!==s){var o=Vt(e,i,s),a=P+n;zt(e,a,e[r][n],o.x1,o.y1,o.x2,o.y2)}}}function zt(e,n,r,i,s,o,a){var f=j+n+b+r,l=C+r+")",c=t(document.createElementNS("http://www.w3.org/2000/svg","line"));return c.attr({x1:i,y1:s,x2:o,y2:a,"class":f,"marker-end":l}),t(H,e[u])[ft](c),c}function Wt(e,r){var i=e[n][_]?W:I,s=e[n][_]?R:U,a=i[ct](r[1]),f=s[ct](r[0]);return t(t(o,e[u]).get(a*8+f))}function Xt(e,t){var r=e[n][_]?W:I,i=e[n][_]?R:U;return{x:i[ct](t[0])+.5,y:r[ct](t[1])+.5}}function Vt(e,t,n){var r=Xt(e,t),i=Xt(e,n);return i.x+=r.x<i.x?-0.3:r.x>i.x?.3:0,i.y+=r.y<i.y?-0.3:r.y>i.y?.3:0,{x1:r.x,y1:r.y,x2:i.x,y2:i.y}}function $t(e){var r=e[n][_]?W:I,i=e[n][_]?R:U,s=0,a=0;t(o,e[u]).each(function(e,n){t(n).data(m,i[a]+r[s]),++a,a===8&&(a=0,++s)})}function Jt(e,r){t(Q,e[u])[pt]({cursor:"move",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},revert:it,revertDuration:0,zIndex:300});var i=t(a,e[u]).get(0),s=r?Zt:Yt;t(o,e[u]).droppable({hoverClass:F,accept:function(e){return t(e).closest(a).get(0)===i},drop:function(r,i){var o=t(r.target),u=i[pt];if(u.hasClass("uichess-chessboard-piece")){var a={from:u.parent().data(m),to:o.data(m)};s(e,a,M,e[n][S])}}})}function Kt(e,n){t(o,e[u]).mousedown(function(){nn(e,n,t(this).data(m),t(this))})}function Qt(e,n){t(o,e[u]).mousedown(function(){rn(e,n,t(this).data(m),t(this))})}function Gt(e,r){function p(e){return(e-s.left)*8/c}function d(e){return(e-s.top)*8/h}var i=T,s=T,f=t(H,e[u]),c=f.width(),h=f.height();t(".uichess-chessboard-square .uichess-chessboard-handle",e[u])[pt]({cursor:"crosshair",cursorAt:{top:e[n][l]/2,left:e[n][l]/2},helper:function(){return t('<div class="uichess-chessboard-sized"></div>')},start:function(n){i=t(n.target).closest(o).data(m),s=f.offset();var u=Xt(e,i);zt(e,"uichess-chessboard-draggedArrow",r,u.x,u.y,u.x,u.y)},drag:function(n){t(D,e[u]).attr({x2:p(n.pageX),y2:d(n.pageY)})},stop:function(){t(D,e[u])[lt]()}});var v=t(a,e[u]).get(0);t(o,e[u]).droppable({hoverClass:F,accept:function(e){return t(e).closest(a).get(0)===v},drop:function(n){var s=t(n.target).data(m);sn(e,r,i,s)}})}function Yt(e,n,r,i){if(n.from===n.to||e[s][m](n.from)==="-")return;e[s][m](n.to,e[s][m](n.from)),e[s][m](n.from,"-"),t(z,e[u])[lt](),en(e,n.from,n.to,r,i),on(e)}function Zt(n,r,i,o){var a=n[s].isMoveLegal(r);if(!a)return;n[s][ot](a),t(z,n[u])[lt]();var f=en(n,a.from(),a.to(),i,o);a.type()===e[dt].CASTLING_MOVE&&en(n,a.rookFrom(),a.rookTo(),i,M),a.type()===e[dt].EN_PASSANT_CAPTURE&&Wt(n,a.enPassantSquare())[Y]()[ft](gt),a.type()===e[dt].PROMOTION&&tn(n,i,.8,function(){f[v]("uichess-chessboard-piece-p")[k]("uichess-chessboard-piece-"+a.promotion())}),t(B,n[u])[nt](O),on(n)}function en(r,i,s,o,u){var a=t(Q,Wt(r,i));a.parent()[ft](gt),Wt(r,s)[Y]()[ft](a);if(u){var f=Vt(r,i,s);tn(r,o,.5,function(){zt(r,"uichess-chessboard-moveArrow","B",f.x1,f.y1,f.x2,f.y2)})}if(o){var c=e[ut](i),h=e[ut](s),p=(c.r-h.r)*r[n][l]*(r[n][_]?1:-1),v=(h.c-c.c)*r[n][l]*(r[n][_]?1:-1);a.css("top",p+"px"),a.css("left",v+"px"),a.animate({top:"0px",left:"0px"},r[n][d])}return a}function tn(e,t,r,i){t?setTimeout(i,e[n][d]*r):i()}function nn(e,t,n,r){var i=e[s][m](n);typeof i=="object"&&i.color===t.color&&i.piece===t.piece?(e[s][m](n,"-"),r[Y]()[ft](gt)):(e[s][m](n,t),r[Y]()[ft](p+t.piece+q+t.color+'">'+gt+N)),on(e)}function rn(e,t,n,r){e[i][n]===t?(It(r,t),delete e[i][n]):(It(r,e[i][n],t),e[i][n]=t),un(e)}function sn(e,t,n,i){var s=n+i;e[r][s]===t?(Rt(e,s,e[r][s]),delete e[r][s]):(Rt(e,s,e[r][s],t),e[r][s]=t),an(e)}function on(e){var t=e[n][L];e[n][L]=e[s].fen(),e[V](st,T,{oldValue:t,newValue:e[n][L]})}function un(e){var t=e[n][g];e[n][g]=xt(e[i]),e[V](Z,T,{oldValue:t,newValue:e[n][g]})}function an(e){var t=e[n][w];e[n][w]=xt(e[r]),e[V](tt,T,{oldValue:t,newValue:e[n][w]})}var n="options",r="_arrowMarkers",i="_squareMarkers",s="_position",o=".uichess-chessboard-square",u="element",a=".uichess-chessboard-table",f="uichess-chessboard-markerColor-",l="squareSize",c="interactionMode",h="uichess-chessboard-squareMarker",p='<div class="uichess-chessboard-sized uichess-chessboard-piece uichess-chessboard-piece-',d="animationSpeed",v="removeClass",m="square",g="squareMarkers",y="undefined",b=" uichess-chessboard-markerColor-",w="arrowMarkers",E="_initialGeometryInfo",S="showMoveArrow",x="showCoordinates",T=null,N="</div>",C="url(#uichess-chessboard-arrowMarkerEnd-",k="addClass",L="position",A="hasOwnProperty",O="uichess-chessboard-inactiveFlag",M=!1,_="flip",D=".uichess-chessboard-draggedArrow",P="uichess-chessboard-arrowMarker-",H=".uichess-chessboard-annotations",B=".uichess-chessboard-turnFlag",j="uichess-chessboard-arrowMarker ",F="uichess-chessboard-squareHover",I="87654321",q=" uichess-chessboard-color-",R="hgfedcba",U="abcdefgh",z=".uichess-chessboard-moveArrow",W="12345678",X='<div class="',V="_trigger",$="pieceset",J="colorset",K="uichess-chessboard-size",Q=".uichess-chessboard-piece",G="test",Y="empty",Z="squareMarkersChange",et="uichess-chessboard",tt="arrowMarkersChange",nt="toggleClass",rt="castleRights",it=!0,st="positionChange",ot="play",ut="squareToCoordinates",at="movePieces",ft="append",lt="remove",ct="indexOf",ht="enPassant",pt="draggable",dt="movetype",vt=12,mt=64,gt='<div class="uichess-chessboard-handle"></div>',yt=/^\s*([GRY])([a-h][1-8])\s*$/,bt=/^\s*([GRY])([a-h][1-8][a-h][1-8])\s*$/,wt=/^\s*[GRY]?([a-h][1-8])\s*$/,Et=/^\s*[GRY]?([a-h][1-8][a-h][1-8])\s*$/;t.chessboard={MINIMUM_SQUARE_SIZE:vt,MAXIMUM_SQUARE_SIZE:mt},t.widget("uichess.chessboard",{options:{position:Y,squareMarkers:"",arrowMarkers:"",flip:M,squareSize:32,showCoordinates:it,animationSpeed:200,showMoveArrow:M,interactionMode:"none",colorset:"",pieceset:""},_position:T,_squareMarkers:T,_arrowMarkers:T,_create:function(){this[u][k](et).disableSelection(),this[n][L]=At(this,this[n][L]),this[n][g]=Ot(this,this[n][g]),this[n][w]=Mt(this,this[n][w]),this[n][l]=Nt(this[n][l]),this[n][c]=kt(this[n][c]),this[n][d]=Lt(this[n][d]),this[n][_]=Tt(this[n][_],M),this[n][x]=Tt(this[n][x],it),this[n][S]=Tt(this[n][S],M),this[n][J]=Ct(this[n][J]),this[n][$]=Ct(this[n][$]),Ht(this)},_destroy:function(){this[u][Y]()[v](et).enableSelection()},_setOption:function(e,t){switch(e){case L:t=At(this,t);break;case g:t=Ot(this,t);break;case w:t=Mt(this,t);break;case l:t=Nt(t);break;case c:t=kt(t);break;case d:t=Lt(t);break;case _:t=Tt(t,M);break;case x:t=Tt(t,it);break;case S:t=Tt(t,M);break;case J:t=Ct(t);break;case $:t=Ct(t)}var r=this[n][e];if(r===t)return;this[n][e]=t;switch(e){case L:Ht(this),this[V](st,T,{oldValue:r,newValue:this[n][L]});break;case _:Ht(this),this[V]("flipChange",T,{oldValue:r,newValue:this[n][_]});break;case g:qt(this),this[V](Z,T,{oldValue:r,newValue:this[n][g]});break;case w:Ut(this),this[V](tt,T,{oldValue:r,newValue:this[n][w]});break;case l:jt(this,r,t);break;case x:Ft(this);break;case d:break;case S:break;default:Ht(this)}},turn:function(e){if(typeof e===y||e===T)return this[s].turn();e!==this[s].turn()&&(this[s].turn(e),Bt(this),on(this))},castleRights:function(e,t,n){if(typeof n===y||n===T)return this[s][rt](e,t);n!==this[s][rt](e,t)&&(this[s][rt](e,t,n),on(this))},enPassant:function(e){if(typeof e===y||e===T)return this[s][ht]();e!==this[s][ht]()&&(this[s][ht](e),on(this))},movePiece:function(e){Yt(this,e,this[n][d]>0,this[n][S])},play:function(e){Zt(this,e,this[n][d]>0,this[n][S])},addSquareMarker:function(e){if(yt[G](e)){var t=RegExp.$1,n=RegExp.$2;this[i][n]!==t&&(It(Wt(this,n),this[i][n],t),this[i][n]=t,un(this))}},removeSquareMarker:function(e){if(wt[G](e)){var t=RegExp.$1;typeof this[i][t]!==y&&(It(Wt(this,t),this[i][t]),delete this[i][t],un(this))}},addArrowMarker:function(e){if(bt[G](e)){var t=RegExp.$1,n=RegExp.$2;this[r][n]!==t&&(Rt(this,n,this[r][n],t),this[r][n]=t,an(this))}},removeArrowMarker:function(e){if(Et[G](e)){var t=RegExp.$1;typeof this[r][t]!==y&&(Rt(this,t,this[r][t]),delete this[r][t],an(this))}},sizeControlledByContainer:function(e,t){var r=this;e.on(t,function(e,t){r[E]===undefined&&(r[E]={squareSize:r[n][l],height:t.originalSize.height,width:t.originalSize.width});var i=t.size.width-r[E].width,s=t.size.height-r[E].height,o=Math.floor(i/9),u=Math.floor(s/8),a=r[E][l]+Math.min(o,u);r._setOption(l,a)})}})})(RPBChess,jQuery);